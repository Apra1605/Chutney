<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Robot Camera + Gemini Vision + Sensor</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    img { width: 360px; height: 270px; object-fit: cover; border: 2px solid #ccc; }
    #cmd, #dist { font-size: 2em; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Robot Camera + Gemini Vision + Sensor</h1>
  <img id="live" src="" alt="Live camera snapshot" />
  <div id="cmd">--</div>
  <div id="dist">Distance: -- cm</div>
  <script>
    // ---- EDIT HERE ----
    const GEMINI_API_KEY = 'AIzaSyBELzK5j4T6kss4ZQSz4OLB7OLX-Bo_WO4';
    const SNAP_URL = 'https://192.168.86.34:8080/shot.jpg';    // Phone camera IP Webcam
    const ARDUINO_IP = '192.168.86.50';                       // Arduino fixed IP
    // -------------------

    // Fetch distance from Arduino
    async function fetchDistance() {
      try {
        const r = await fetch(`http://${ARDUINO_IP}/distance`);
        const txt = await r.text();
        document.getElementById('dist').textContent = `Distance: ${txt.trim()} cm`;
      } catch (e) {
        document.getElementById('dist').textContent = 'Distance: N/A';
      }
      setTimeout(fetchDistance, 2000);
    }

    // Run AI, show command, send command to Arduino
    async function fetchAndSend() {
      try {
        const rnd = Date.now();
        const imgUrl = SNAP_URL + '?rnd=' + rnd;
        document.getElementById('live').src = imgUrl;

        // Fetch image as blob and convert to Base64
        const resp = await fetch(imgUrl);
        const blob = await resp.blob();
        const base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });

        // Gemini Vision API request body
        const body = JSON.stringify({
          contents: [
            {
              parts: [
                {
                  inline_data: {
                    mime_type: blob.type,
                    data: base64
                  }
                },
                {
                  text: "Respond with only one word: FORWARD, BACKWARD, LEFT, RIGHT, or STOP. Your only purpose is to move towards a human. If no human is in the picture, say STOP."
                }
              ]
            }
          ]
        });

        // Call Gemini Vision API
        const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const aiResp = await fetch(geminiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body
        });
        const aiJson = await aiResp.json();

        // Parse and display command
        let cmd = '--';
        if (aiJson && aiJson.candidates && aiJson.candidates.length) {
          cmd = aiJson.candidates[0].content.parts[0].text.trim().toUpperCase();
        } else if (aiJson.error) {
          cmd = 'ERR: ' + aiJson.error.message;
        }
        document.getElementById('cmd').textContent = cmd;

        // --- Send command to Arduino ---
        if (["FORWARD","BACKWARD","LEFT","RIGHT","STOP"].includes(cmd)) {
          fetch(`http://${ARDUINO_IP}/cmd?move=${encodeURIComponent(cmd)}`)
            .catch(e => console.warn('Send to Arduino failed:', e));
        }
      } catch (e) {
        document.getElementById('cmd').textContent = 'Error: ' + e.message;
      }
      setTimeout(fetchAndSend, 2000);
    }

    fetchAndSend();
    fetchDistance();
  </script>
</body>
</html>
