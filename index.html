<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Robot Camera + Gemini Vision</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    img { width: 360px; height: 270px; object-fit: cover; border: 2px solid #ccc; }
    #cmd { font-size: 2em; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Robot Camera + Gemini Vision</h1>
  <img id="live" src="" alt="Live camera snapshot" />
  <div id="cmd">--</div>
  <script>
    // ---- EDIT HERE ----
    const GEMINI_API_KEY = 'AIzaSyBELzK5j4T6kss4ZQSz4OLB7OLX-Bo_WO4'; // Replace with your Gemini API key!
    const SNAP_URL = 'http://192.168.86.34:8080/shot.jpg';
    // -------------------

    async function fetchAndSend() {
      try {
        // 1. Update image tag with no-cache
        const rnd = Date.now();
        const imgUrl = SNAP_URL + '?rnd=' + rnd;
        document.getElementById('live').src = imgUrl;

        // 2. Fetch the image as blob and convert to Base64
        const resp = await fetch(imgUrl);
        const blob = await resp.blob();
        const base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });

        // 3. Build Gemini Vision JSON body
        const body = JSON.stringify({
          contents: [
            {
              parts: [
                {
                  inline_data: {
                    mime_type: blob.type,
                    data: base64
                  }
                },
                {
                  text: "Respond with only one word: FORWARD, BACKWARD, LEFT, RIGHT, or STOP"
                }
              ]
            }
          ]
        });

        // 4. Call Gemini Vision API
        const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const aiResp = await fetch(geminiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body
        });
        const aiJson = await aiResp.json();

        // 5. Parse response (show error if any)
        let cmd = '--';
        if (aiJson && aiJson.candidates && aiJson.candidates.length) {
          cmd = aiJson.candidates[0].content.parts[0].text.trim();
        } else if (aiJson.error) {
          cmd = 'ERR: ' + aiJson.error.message;
        }
        document.getElementById('cmd').textContent = cmd;
      } catch (e) {
        document.getElementById('cmd').textContent = 'Error: ' + e.message;
      }
      setTimeout(fetchAndSend, 2000);
    }
    fetchAndSend();
  </script>
</body>
</html>
